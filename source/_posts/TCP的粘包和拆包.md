---
title: TCP的粘包和拆包
cover: false
top: false
categories:
  - 计算机网络
tags:
  - TCP/IP
  - 粘包拆包
abbrlink: 7157
date: 2021-10-13 19:13:27
summary:
---

## 什么是粘包和拆包
一个完整的业务数据包可能会被TCP拆分成多个包进行发送，也有可能把多个小的包封装成一个大的数据包发送，这个就是TCP的拆包和粘包问题。
#### 第一种情况(正常)
接收端正常收到两个数据包，即没有发生拆包和粘包的现象；

![在这里插入图片描述](https://img-blog.csdnimg.cn/0dd185d80ed7419c99f241e13d97b33c.png)

#### 第二种情况
接收端只收到一个数据包，由于TCP是不会出现丢包的，所以这一个数据包中包含了发送端发送的两个数据包的信息，这种现象即为粘包。

这种情况由于接收端不知道这两个数据包的界限，所以对于接收端来说很难处理。
![在这里插入图片描述](https://img-blog.csdnimg.cn/5b0e17395ab0423a8b2c275fcf8de9eb.png)
#### 第三种情况
接收端收到了两个数据包，但是这两个数据包要么是不完整的，要么就是多出来一块，这种情况即发生了拆包和粘包。
![在这里插入图片描述](https://img-blog.csdnimg.cn/2ebf028e7f7a404490314f5d6f41cd86.png)
这两种情况如果不加特殊处理，对于接收端同样是不好处理的
![在这里插入图片描述](https://img-blog.csdnimg.cn/0b1efe60580848bca400bf9e802a7fef.png)
## 原因
1. 应用程序写入的数据大于套接字缓冲区大小，这将会发生拆包。

2. 应用程序写入数据小于套接字缓冲区大小，网卡将应用多次写入的数据发送到网络上，这将会发生粘包。

3. 进行MSS（最大报文长度）大小的TCP分段，当TCP报文长度-TCP头部长度>MSS的时候将发生拆包。

4. 接收方法不及时读取套接字缓冲区数据，这将发生粘包。

## 解决
1. 发送端给每个数据包添加包首部，首部中应该至少包含数据包的长度，这样接收端在接收到数据后，通过读取包首部的长度字段，便知道每一个数据包的实际长度了。

2. 发送端将每个数据包封装为固定长度（不够的可以通过补0填充），这样接收端每次从接收缓冲区中读取固定长度的数据就自然而然的把每个数据包拆分开来。

3. 可以在数据包之间设置边界，如添加特殊符号，这样，接收端通过这个边界就可以将不同的数据包拆分开。
 