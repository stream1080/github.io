---
title: MySQL如何避免幻读
top: false
cover: false
toc: true
mathjax: false
categories:
  - 数据库
tags:
  - 幻读
  - MVCC
  - next-key
abbrlink: 39079
date: 2021-11-14 16:22:24
author:
img:
coverImg:
password:
summary:
---


## 事务的并发问题

1. 脏读：事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据
2. 不可重复读：事务A多次读取同一数据，事务B在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果不一致。
3. 幻读：A事务读取了B事务已经提交的新增数据。注意和不可重复读的区别，这里是新增，不可重复读是更改（或删除）。select某记录是否存在，不存在，准备插入此记录，但执行 insert 时发现此记录已存在，无法插入，此时就发生了幻读。

## MySQL如何实现避免幻读

- 在快照读读情况下，MySQL通过MVCC来避免幻读。
- 在当前读读情况下，MySQL通过next-key来避免幻读

## 什么是MVCC

MVCC全称是多版本并发控制的简称(multi version concurrent control)。MySQL把每个操作都定义成一个事务，每开启一个事务，系统的事务版本号自动递增。每行记录都有两个隐藏列：创建版本号和删除版本号

MVCC多版本并发控制是MySQL中基于乐观锁理论实现隔离级别的方式，用于读已提交和可重复读取隔离级别的实现。

在MySQL中，会在表中每一条数据后面添加两个字段：最近修改该行数据的事务ID，指向该行（undolog表中）回滚段的指针。

Read View判断行的可见性，创建一个新事务时，copy一份当前系统中的活跃事务列表。意思是，当前不应该被本事务看到的其他事务id列表。已提交读隔离级别下的事务在每次查询的开始都会生成一个独立的ReadView,而可重复读隔离级别则在第一次读的时候生成一个ReadView，之后的读都复用之前的ReadView。

- select：事务每次只能读到创建版本号小于等于此次系统版本号的记录，同时行的删除版本号不存在或者大于当前事务的版本号。

- update：插入一条新记录，并把当前系统版本号作为行记录的版本号，同时保存当前系统版本号到原有的行作为删除版本号。

- delete：把当前系统版本号作为行记录的删除版本号

- insert：把当前系统版本号作为行记录的版本号

## 什么是next-key锁

InnoDB 采用 Next-Key Lock 解决幻读问题。

```bash
insert into test(xid) values (1), (3), (5), (8), (11)
```
在这条语句执行后，由于xid上是有索引的，该算法总是会去锁住索引记录
现在，该索引可能被锁住的范围如下：(-∞, 1], (1, 3], (3, 5], (5, 8], (8, 11], (11, +∞)。

```bash
select * from test where id = 8 for update
```
这条语句执行后会锁住的范围：(5, 8], (8, 11]。
除了锁住8所在的范围，还会锁住下一个范围，所谓Next-Key。

